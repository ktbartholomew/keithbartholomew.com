pipeline:
  build:
    image: node:6.9.5
    environment:
      - NPM_CONFIG_LOGLEVEL=warn
      - NODE_ENV=production
    commands:
      - npm install
      - scripts/build-frontend.sh
  push:
    image: plugins/docker
    registry: quay.io
    repo: quay.io/ktbartholomew/keithbartholomew.com
    secrets:
      - docker_username
      - docker_password
    tags:
      - "latest"
      - "${DRONE_COMMIT_SHA}"
    when:
      branch: master
      event: [push, tag, deployment]
  kube_deploy:
    image: gcr.io/google_containers/hyperkube:v1.7.5
    secrets:
      - kubeconfig
    commands:
      - echo "$KUBECONFIG" > /kubeconfig
      - kubectl --kubeconfig /kubeconfig -n keithbartholomew set image deployment/keithbartholomew keithbartholomew=quay.io/ktbartholomew/keithbartholomew.com:${DRONE_COMMIT_SHA} --record
      - kubectl --kubeconfig /kubeconfig -n keithbartholomew rollout status deployment/keithbartholomew
    when:
      branch: master
      event: [push, tag, deployment]
  kube_deploy_undo:
    image: gcr.io/google_containers/hyperkube:v1.7.5
    secrets:
      - kubeconfig
    commands:
      - echo "$KUBECONFIG" > /kubeconfig
      - kubectl --kubeconfig /kubeconfig -n keithbartholomew rollout undo deployment/keithbartholomew
    when:
      branch: master
      event: [push, tag, deployment]
      status: failure
  hangouts_failure_notify:
    image: appleboy/drone-gtalk
    google_host: talk.google.com:443
    google_username: ${HANGOUTS_USERNAME}
    google_password: ${HANGOUTS_PASSWORD}
    to: ${HANGOUTS_RECIPIENT}
    secrets:
      - hangouts_recipient
      - hangouts_username
      - hangouts_password
    # when:
    #   branch: master
    #   event: [push, tag, deployment]
    #   status: failure
